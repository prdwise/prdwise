#!/bin/bash
# T - Task Management CLI for prdwise projects

set -e

# Find tasks directory from current working directory
TASKS_DIR="./tasks"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

err() { echo -e "${RED}Error:${NC} $1" >&2; }
info() { echo -e "${GREEN}==>${NC} $1"; }

# Editor selection: VISUAL > EDITOR > vi
get_editor() {
    echo "${VISUAL:-${EDITOR:-vi}}"
}

show_help() {
    cat << 'EOF'
T - Task Management CLI

Usage:
  T l           List active tasks
  T d <id>      Show task details
  T e <id>      Edit task details
  T s <id>      Show task state (from details header)
  T m           List archive months
  T lm <month>  List tasks for month (YYYYMM, cm=current, pm=previous)
  T em <id>     Edit archived task
  T lb [cat]    List backlog (optional category filter)
  T b <id>      Show backlog task details
  T eb <id>     Edit backlog task
  T i           Edit tasks/index.md
  T n           Edit tasks/next-ids.md
  T h           Show this help

Examples:
  T l           # List active tasks
  T d v5        # Show task v5 details
  T e v5        # Edit task v5
  T s v5        # Show state of task v5
  T lm cm       # List current month's archived tasks
  T lb          # List all backlog
  T lb i        # List infrastructure backlog (bli*)
EOF
}

check_tasks_dir() {
    if [[ ! -d "$TASKS_DIR" ]]; then
        err "tasks/ directory not found in current directory"
        echo "Run this from a project with prdwise task management set up."
        exit 1
    fi
}

list_tasks() {
    check_tasks_dir
    if [[ ! -f "$TASKS_DIR/index.md" ]]; then
        err "tasks/index.md not found"
        return 1
    fi
    echo "=== Active Tasks ==="
    echo ""
    grep -E "^- \[" "$TASKS_DIR/index.md"|sort || echo "(no tasks)"
}

show_details() {
    check_tasks_dir
    local task_id="$1"
    if [[ -z "$task_id" ]]; then
        err "Please specify a task ID"
        return 1
    fi

    local details_file="$TASKS_DIR/details/${task_id}.md"
    if [[ ! -f "$details_file" ]]; then
        err "Task not found: $details_file"
        echo ""
        echo "Available tasks:"
        ls "$TASKS_DIR/details/" 2>/dev/null | sed 's/\.md$//' | sort
        return 1
    fi

    echo "=== $task_id ==="
    echo ""
    cat "$details_file"
}

edit_task() {
    check_tasks_dir
    local task_id="$1"
    if [[ -z "$task_id" ]]; then
        err "Please specify a task ID"
        return 1
    fi

    local details_file="$TASKS_DIR/details/${task_id}.md"
    if [[ ! -f "$details_file" ]]; then
        err "Task not found: $details_file"
        echo ""
        echo "Available tasks:"
        ls "$TASKS_DIR/details/" 2>/dev/null | sed 's/\.md$//' | sort
        return 1
    fi

    $(get_editor) "$details_file"
}

show_state() {
    check_tasks_dir
    local task_id="$1"

    if [[ -z "$task_id" ]]; then
        err "Please specify a task ID"
        return 1
    fi

    local details_file="$TASKS_DIR/details/${task_id}.md"
    if [[ ! -f "$details_file" ]]; then
        err "Task not found: $details_file"
        return 1
    fi

    echo "=== $task_id state ==="
    echo ""
    head -10 "$details_file" | grep -E "^(State:|Next:|Blocked:|Outcome:)" || echo "(no state header found)"
}

list_months() {
    echo "=== Archive Months ==="
    echo ""
    ls -d ./archives/[0-9][0-9][0-9][0-9][0-9][0-9] 2>/dev/null | xargs -n1 basename | sort -r || echo "(no archives)"
}

list_month_tasks() {
    local month="$1"

    if [[ -z "$month" ]]; then
        err "Please specify a month (YYYYMM, cm, or pm)"
        return 1
    fi

    # Handle shortcuts
    case "$month" in
        cm) month=$(date +%Y%m) ;;
        pm) month=$(date -d "last month" +%Y%m 2>/dev/null || date -v-1m +%Y%m) ;;
    esac

    local month_dir="./archives/$month"
    if [[ ! -d "$month_dir" ]]; then
        err "Archive not found: $month"
        echo ""
        list_months
        return 1
    fi

    echo "=== Archived â€” $month ==="
    echo ""
    for f in "$month_dir"/*.md; do
        [[ -f "$f" ]] || continue
        head -1 "$f" | sed 's/^# //'
    done
}

edit_archived_task() {
    local task_id="$1"
    if [[ -z "$task_id" ]]; then
        err "Please specify a task ID"
        return 1
    fi

    # Search in archive directories
    local found=$(find ./archives -path "./archives/[0-9]*/${task_id}.md" -type f 2>/dev/null | head -1)
    if [[ -z "$found" ]]; then
        err "Archived task not found: $task_id"
        return 1
    fi

    $(get_editor) "$found"
}

list_backlog() {
    check_tasks_dir
    local category="$1"

    if [[ ! -f "$TASKS_DIR/backlog/index.md" ]]; then
        err "tasks/backlog/index.md not found"
        return 1
    fi

    if [[ -z "$category" ]]; then
        echo "=== Backlog ==="
        echo ""
        cat "$TASKS_DIR/backlog/index.md"
    else
        echo "=== Backlog (bl${category}*) ==="
        echo ""
        grep "bl${category}" "$TASKS_DIR/backlog/index.md" || echo "(none)"
    fi
}

show_backlog_detail() {
    check_tasks_dir
    local task_id="$1"
    if [[ -z "$task_id" ]]; then
        err "Please specify a backlog task ID"
        return 1
    fi

    local backlog_file="$TASKS_DIR/backlog/${task_id}.md"
    if [[ ! -f "$backlog_file" ]]; then
        err "Backlog task not found: $backlog_file"
        echo ""
        echo "Available:"
        ls "$TASKS_DIR/backlog/"bl*.md 2>/dev/null | xargs -n1 basename | sed 's/\.md$//' | sort | head -20
        return 1
    fi

    echo "=== $task_id ==="
    echo ""
    cat "$backlog_file"
}

edit_backlog() {
    check_tasks_dir
    local task_id="$1"
    if [[ -z "$task_id" ]]; then
        err "Please specify a backlog task ID"
        return 1
    fi

    local backlog_file="$TASKS_DIR/backlog/${task_id}.md"
    if [[ ! -f "$backlog_file" ]]; then
        err "Backlog task not found: $backlog_file"
        return 1
    fi

    $(get_editor) "$backlog_file"
}

edit_index() {
    check_tasks_dir
    $(get_editor) "$TASKS_DIR/index.md"
}

edit_next_ids() {
    check_tasks_dir
    $(get_editor) "$TASKS_DIR/next-ids.md"
}

# Main
case "${1:-h}" in
    l|list)         list_tasks ;;
    d|details)      show_details "$2" ;;
    e|edit)         edit_task "$2" ;;
    s|state)        show_state "$2" ;;
    m|months)       list_months ;;
    lm|list-month)  list_month_tasks "$2" ;;
    em|edit-month)  edit_archived_task "$2" ;;
    lb|list-backlog) list_backlog "$2" ;;
    b|backlog)      show_backlog_detail "$2" ;;
    eb|edit-backlog) edit_backlog "$2" ;;
    i|index)        edit_index ;;
    n|next-ids)     edit_next_ids ;;
    h|help|--help)  show_help ;;
    *)
        err "Unknown command '$1'"
        echo ""
        show_help
        exit 1
        ;;
esac
